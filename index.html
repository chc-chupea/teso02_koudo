<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenCV.js 手のひら切り出しサンプル</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 1rem;}
    video, canvas { max-width: 100%; border-radius: 10px; margin: 0.5rem 0;}
    button { font-size: 1rem; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <h1>OpenCV.js 手のひら切り出しサンプル</h1>
  <video id="video" autoplay playsinline></video>
  <br />
  <button id="startBtn" disabled>カメラ起動</button>
  <button id="captureBtn" disabled>手のひら切り出し</button>
  <br />
  <canvas id="canvasOutput"></canvas>

  <!-- OpenCV.js読み込み -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvasOutput = document.getElementById('canvasOutput');
    const ctx = canvasOutput.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');

    let streaming = false;

    // OpenCV.js読み込み完了フラグ
    let cvReady = false;

    // OpenCV.jsの準備完了時に呼ばれる
    cv['onRuntimeInitialized'] = () => {
      console.log('OpenCV.js is ready');
      cvReady = true;
      startBtn.disabled = false;
    };

    // カメラ起動
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        await video.play();
        streaming = true;

        // canvasサイズをvideoに合わせる
        canvasOutput.width = video.videoWidth;
        canvasOutput.height = video.videoHeight;

        captureBtn.disabled = false;
      } catch (err) {
        alert('カメラの起動に失敗しました: ' + err);
      }
    }

    // 手のひら切り出し処理（簡易版）
    function processFrame() {
      if (!streaming) return;

      // videoの現在フレームをcanvasに描画
      ctx.drawImage(video, 0, 0, canvasOutput.width, canvasOutput.height);

      // canvasからOpenCVのMatを作成
      let src = cv.imread(canvasOutput);
      let dst = new cv.Mat();

      // グレースケール変換
      cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

      // ぼかしを入れてノイズ軽減
      cv.GaussianBlur(dst, dst, new cv.Size(7,7), 0);

      // 二値化（Cannyでエッジ抽出）
      let edges = new cv.Mat();
      cv.Canny(dst, edges, 50, 150);

      // エッジ画像をカラーに変換してcanvasに表示
      cv.cvtColor(edges, dst, cv.COLOR_GRAY2RGBA);
      cv.imshow(canvasOutput, dst);

      // メモリ解放
      src.delete();
      dst.delete();
      edges.delete();
    }

    startBtn.addEventListener('click', () => {
      if (!cvReady) {
        alert('OpenCV.jsがまだ読み込まれていません。少し待ってからもう一度押してください。');
        return;
      }
      startCamera();
      startBtn.disabled = true;
    });

    captureBtn.addEventListener('click', () => {
      processFrame();
    });

  </script>

</body>
</html>
